<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro Corrida</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 800px;
            display: flex;
            gap: 20px;
        }

        form {
            flex: 1;
        }

        .vagas {
            flex: 1;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        h2, h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .alerta {
            color: red;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }

        .vagas ul {
            list-style: none;
            padding: 0;
        }

        .vagas li {
            padding: 5px 0;
            font-weight: bold;
        }

        .vagas span {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <form id="cadastroForm">
            <h2>Cadastro Corrida</h2>

            <label for="nome">Nome:</label>
            <input type="text" id="nome" name="nome" required>

            <label for="telefone">Telefone:</label>
            <input type="tel" id="telefone" name="telefone" required>

            <label for="nascimento">Data de Nascimento:</label>
            <input type="date" id="nascimento" name="nascimento" required>

            <label for="idade">Idade:</label>
            <input type="number" id="idade" name="idade" readonly>

            <label for="sexo">Sexo:</label>
            <select id="sexo" name="sexo" required>
                <option value="">Selecione</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
                <option value="Outro">Outro</option>
            </select>

            <label for="camiseta">Tamanho da camiseta:</label>
            <select id="camiseta" name="camiseta" required>
                <option value="">Selecione</option>
                <option value="PP">PP</option>
                <option value="P">P</option>
                <option value="M">M</option>
                <option value="G">G</option>
                <option value="GG">GG</option>
            </select>

            <button type="submit">Cadastrar</button>
            <p id="mensagem" class="alerta"></p>
        </form>

        <div class="vagas">
            <h3>Vagas Restantes</h3>
            <ul id="listaVagas">
                <!-- Vagas serão atualizadas via JS -->
            </ul>
            <p id="erroVagas" class="alerta"></p>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const supabaseUrl = 'https://ciynopzakjblzavqxomv.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpeW5vcHpha2pibHphdnF4b212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTQxNjEsImV4cCI6MjA3MjA5MDE2MX0.KyhWkYsMj7Fhdh6Hfb0CamfqpiD2IwCuer7B1W-AvFA'
        const supabase = createClient(supabaseUrl, supabaseKey)

        const form = document.getElementById('cadastroForm');
        const nascimentoInput = document.getElementById('nascimento');
        const idadeInput = document.getElementById('idade');
        const mensagem = document.getElementById('mensagem');
        const listaVagas = document.getElementById('listaVagas');
        const erroVagas = document.getElementById('erroVagas');
        const botaoCadastro = form.querySelector('button[type="submit"]');

        const MAX_VAGAS_INFANTIL = 15;
        const MAX_VAGAS_ADULTO = 35;

        function calcularIdade(dataNascimento) {
            const hoje = new Date();
            const nascimento = new Date(dataNascimento);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mes = hoje.getMonth() - nascimento.getMonth();
            if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) idade--;
            return idade;
        }

        async function atualizarListaVagas() {
            let vagasInfantil = {};
            for (let i = 5; i <= 15; i++) vagasInfantil[i] = MAX_VAGAS_INFANTIL;
            let vagasAdulto = MAX_VAGAS_ADULTO;

            const { data: inscritos, error } = await supabase.from('inscricoes').select('idade');
            if (error) {
                console.error("Erro ao buscar inscritos:", error.message);
                erroVagas.textContent = "Não foi possível carregar as vagas.";
                return;
            } else {
                erroVagas.textContent = "";
            }

            inscritos.forEach(inscrito => {
                const idade = inscrito.idade;
                if (idade >= 5 && idade <= 15) vagasInfantil[idade]--;
                else if (idade >= 16) vagasAdulto--;
            });

            listaVagas.innerHTML = "";
            for (let i = 5; i <= 15; i++) {
                listaVagas.innerHTML += `<li>Infantil ${i} anos: <span>${vagasInfantil[i]}</span> vagas</li>`;
            }
            listaVagas.innerHTML += `<li>Adulto (16+): <span>${vagasAdulto}</span> vagas</li>`;

            const todasInfantilEsgotadas = Object.values(vagasInfantil).every(v => v <= 0);
            const adultoEsgotado = vagasAdulto <= 0;
            if (todasInfantilEsgotadas && adultoEsgotado) {
                botaoCadastro.disabled = true;
                botaoCadastro.textContent = "Inscrições encerradas";
            } else {
                botaoCadastro.disabled = false;
                botaoCadastro.textContent = "Cadastrar";
            }

            return { vagasInfantil, vagasAdulto };
        }

        nascimentoInput.addEventListener('change', function () {
            idadeInput.value = calcularIdade(this.value);
        });

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const nome = document.getElementById('nome').value;
            const telefone = document.getElementById('telefone').value;
            const nascimento = document.getElementById('nascimento').value;
            const idade = calcularIdade(nascimento);
            const sexo = document.getElementById('sexo').value;
            const camiseta = document.getElementById('camiseta').value;

            if (!idade || idade < 5) {
                mensagem.textContent = "A idade mínima para inscrição é 5 anos.";
                return;
            }

            const { vagasInfantil, vagasAdulto } = await atualizarListaVagas();

            if (idade >= 5 && idade <= 15 && vagasInfantil[idade] <= 0) {
                mensagem.textContent = `Inscrição para ${idade} anos está encerrada.`;
                return;
            } else if (idade >= 16 && vagasAdulto <= 0) {
                mensagem.textContent = "Inscrição para categoria Adulto (16+) está encerrada.";
                return;
            }

            const { data, error } = await supabase
                .from('inscricoes')
                .insert([{ nome, telefone, nascimento, idade, sexo, camiseta }]);

            if (error) {
                mensagem.textContent = "Erro ao enviar inscrição: " + error.message;
                return;
            }

            alert("Cadastro realizado com sucesso!");
            form.reset();
            idadeInput.value = "";
            mensagem.textContent = "";

            await atualizarListaVagas();
        });

        atualizarListaVagas();
    </script>
</body>
</html>
